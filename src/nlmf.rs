use core::fmt::Debug;
use core::iter::Sum;
use core::ops::{Add, Div, Mul, Sub};
use rand_distr::num_traits::Float;

use packed_simd::f32x8;

pub const N_TAPS: usize = 1024;


pub struct NLMF<T> {
    pub weights: [T; N_TAPS],
    mu: T,
    eps: T,
}

impl NLMF<f32>
{
    pub fn new(_n: usize, mu: f32, eps: f32, weights: [f32; N_TAPS]) -> NLMF<f32> {
        let initial_weights: [_; N_TAPS] = weights;
        NLMF {
            weights: initial_weights,
            mu: mu,
            eps: eps,
        }
    }

    pub fn adapt(&mut self, input: &[f32], target: f32, novelty_threshold: f32) -> (f32, f32) {
        // let output: f32 = self.weights.iter().zip(input).map(|(&w, &x)| w * x).sum();
        let output: f32 = self.weights
            .chunks_exact(8)
            .map(f32x8::from_slice_unaligned)
            .zip(input.chunks_exact(8).map(f32x8::from_slice_unaligned))
            .map(|(a, b)| a * b)
            .sum::<f32x8>()
            .sum();

        let error: f32 = target - output;
        let input_dot = input
            .chunks_exact(8)
            .map(f32x8::from_slice_unaligned)
            .zip(input.chunks_exact(8).map(f32x8::from_slice_unaligned))
            .map(|(a, b)| a * b)
            .sum::<f32x8>()
            .sum();
        let nu: f32 = self.mu / (self.eps + input_dot);
        //self.w += nu * x * e**3
        let mut novelty: f32 = 0.0;
        let mut dws: [f32; N_TAPS] = [0.0; N_TAPS];
        for (i, x) in input.iter().enumerate() {
            let dw: f32 = nu * error * x;
            let nov = (dw * error).abs();
            if nov > novelty {
                novelty = nov;
            }
            dws[i] = dw;
        }
        if novelty < novelty_threshold {
            for (w, dw) in self.weights.iter_mut().zip(dws.iter()) {
                *w = *w + dw;
                assert!(!(w.is_nan()));
            }
        };
        (output, novelty)
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use float_cmp::approx_eq;
    #[test]
    fn test_nlmf_adapt() {
        let weights: [f32; N_TAPS] = [0.0; N_TAPS];
        let (n, mu, eps) = (1024, 2.0, 0.5);
        let mut nlmf_filter: NLMF<f32> = NLMF::new(n, mu, eps, weights);
        let filter_input: Vec<f32> = (0..1024).map(|x| x as f32).collect();
        let target = 512.0_f32;
        let (_, _) = nlmf_filter.adapt(&filter_input, target, f32::MAX);
        const ref_weights: [f32; 1024] = [0.0, 2.86521867664422e-06, 5.73043735328844e-06, 8.59565602993266e-06, 1.146087470657688e-05, 1.43260933832211e-05, 1.719131205986532e-05, 2.005653073650954e-05, 2.292174941315376e-05, 2.578696808979798e-05, 2.86521867664422e-05, 3.1517405443086416e-05, 3.438262411973064e-05, 3.724784279637486e-05, 4.011306147301908e-05, 4.2978280149663295e-05, 4.584349882630752e-05, 4.870871750295174e-05, 5.157393617959596e-05, 5.4439154856240175e-05, 5.73043735328844e-05, 6.016959220952862e-05, 6.303481088617283e-05, 6.590002956281705e-05, 6.876524823946128e-05, 7.16304669161055e-05, 7.449568559274972e-05, 7.736090426939393e-05, 8.022612294603816e-05, 8.309134162268238e-05, 8.595656029932659e-05, 8.882177897597081e-05, 9.168699765261504e-05, 9.455221632925926e-05, 9.741743500590348e-05, 0.00010028265368254769, 0.00010314787235919192, 0.00010601309103583614, 0.00010887830971248035, 0.00011174352838912457, 0.0001146087470657688, 0.00011747396574241302, 0.00012033918441905724, 0.00012320440309570145, 0.00012606962177234566, 0.0001289348404489899, 0.0001318000591256341, 0.00013466527780227835, 0.00013753049647892256, 0.00014039571515556676, 0.000143260933832211, 0.0001461261525088552, 0.00014899137118549945, 0.00015185658986214366, 0.00015472180853878787, 0.0001575870272154321, 0.00016045224589207631, 0.00016331746456872052, 0.00016618268324536476, 0.00016904790192200897, 0.00017191312059865318, 0.00017477833927529742, 0.00017764355795194163, 0.00018050877662858586, 0.00018337399530523007, 0.00018623921398187428, 0.00018910443265851852, 0.00019196965133516273, 0.00019483487001180697, 0.00019770008868845118, 0.00020056530736509539, 0.00020343052604173962, 0.00020629574471838383, 0.00020916096339502804, 0.00021202618207167228, 0.0002148914007483165, 0.0002177566194249607, 0.00022062183810160494, 0.00022348705677824915, 0.00022635227545489338, 0.0002292174941315376, 0.0002320827128081818, 0.00023494793148482604, 0.00023781315016147025, 0.00024067836883811449, 0.0002435435875147587, 0.0002464088061914029, 0.00024927402486804714, 0.0002521392435446913, 0.00025500446222133556, 0.0002578696808979798, 0.00026073489957462403, 0.0002636001182512682, 0.00026646533692791245, 0.0002693305556045567, 0.0002721957742812009, 0.0002750609929578451, 0.00027792621163448935, 0.00028079143031113353, 0.00028365664898777777, 0.000286521867664422, 0.0002893870863410662, 0.0002922523050177104, 0.00029511752369435466, 0.0002979827423709989, 0.0003008479610476431, 0.0003037131797242873, 0.00030657839840093155, 0.00030944361707757574, 0.00031230883575421997, 0.0003151740544308642, 0.0003180392731075084, 0.00032090449178415263, 0.00032376971046079687, 0.00032663492913744105, 0.0003295001478140853, 0.0003323653664907295, 0.0003352305851673737, 0.00033809580384401794, 0.0003409610225206622, 0.00034382624119730636, 0.0003466914598739506, 0.00034955667855059483, 0.00035242189722723907, 0.00035528711590388325, 0.0003581523345805275, 0.00036101755325717173, 0.0003638827719338159, 0.00036674799061046015, 0.0003696132092871044, 0.00037247842796374857, 0.0003753436466403928, 0.00037820886531703704, 0.0003810740839936812, 0.00038393930267032546, 0.0003868045213469697, 0.00038966974002361393, 0.0003925349587002581, 0.00039540017737690235, 0.0003982653960535466, 0.00040113061473019077, 0.000403995833406835, 0.00040686105208347925, 0.00040972627076012343, 0.00041259148943676767, 0.0004154567081134119, 0.0004183219267900561, 0.0004211871454667003, 0.00042405236414334456, 0.00042691758281998874, 0.000429782801496633, 0.0004326480201732772, 0.0004355132388499214, 0.00043837845752656563, 0.00044124367620320987, 0.0004441088948798541, 0.0004469741135564983, 0.00044983933223314253, 0.00045270455090978676, 0.00045556976958643095, 0.0004584349882630752, 0.0004613002069397194, 0.0004641654256163636, 0.00046703064429300784, 0.0004698958629696521, 0.00047276108164629626, 0.0004756263003229405, 0.00047849151899958473, 0.00048135673767622897, 0.00048422195635287315, 0.0004870871750295174, 0.0004899523937061616, 0.0004928176123828058, 0.00049568283105945, 0.0004985480497360943, 0.0005014132684127385, 0.0005042784870893826, 0.0005071437057660269, 0.0005100089244426711, 0.0005128741431193154, 0.0005157393617959596, 0.0005186045804726038, 0.0005214697991492481, 0.0005243350178258923, 0.0005272002365025364, 0.0005300654551791807, 0.0005329306738558249, 0.0005357958925324691, 0.0005386611112091134, 0.0005415263298857576, 0.0005443915485624017, 0.000547256767239046, 0.0005501219859156902, 0.0005529872045923344, 0.0005558524232689787, 0.0005587176419456229, 0.0005615828606222671, 0.0005644480792989114, 0.0005673132979755555, 0.0005701785166521997, 0.000573043735328844, 0.0005759089540054882, 0.0005787741726821324, 0.0005816393913587767, 0.0005845046100354208, 0.000587369828712065, 0.0005902350473887093, 0.0005931002660653535, 0.0005959654847419978, 0.000598830703418642, 0.0006016959220952862, 0.0006045611407719304, 0.0006074263594485746, 0.0006102915781252188, 0.0006131567968018631, 0.0006160220154785073, 0.0006188872341551515, 0.0006217524528317958, 0.0006246176715084399, 0.0006274828901850841, 0.0006303481088617284, 0.0006332133275383726, 0.0006360785462150168, 0.0006389437648916611, 0.0006418089835683053, 0.0006446742022449494, 0.0006475394209215937, 0.0006504046395982379, 0.0006532698582748821, 0.0006561350769515264, 0.0006590002956281706, 0.0006618655143048148, 0.000664730732981459, 0.0006675959516581032, 0.0006704611703347474, 0.0006733263890113917, 0.0006761916076880359, 0.0006790568263646801, 0.0006819220450413244, 0.0006847872637179685, 0.0006876524823946127, 0.000690517701071257, 0.0006933829197479012, 0.0006962481384245455, 0.0006991133571011897, 0.0007019785757778339, 0.0007048437944544781, 0.0007077090131311223, 0.0007105742318077665, 0.0007134394504844108, 0.000716304669161055, 0.0007191698878376992, 0.0007220351065143435, 0.0007249003251909876, 0.0007277655438676318, 0.0007306307625442761, 0.0007334959812209203, 0.0007363611998975645, 0.0007392264185742088, 0.000742091637250853, 0.0007449568559274971, 0.0007478220746041414, 0.0007506872932807856, 0.0007535525119574298, 0.0007564177306340741, 0.0007592829493107183, 0.0007621481679873624, 0.0007650133866640067, 0.0007678786053406509, 0.0007707438240172951, 0.0007736090426939394, 0.0007764742613705836, 0.0007793394800472279, 0.000782204698723872, 0.0007850699174005162, 0.0007879351360771605, 0.0007908003547538047, 0.0007936655734304489, 0.0007965307921070932, 0.0007993960107837374, 0.0008022612294603815, 0.0008051264481370258, 0.00080799166681367, 0.0008108568854903142, 0.0008137221041669585, 0.0008165873228436027, 0.0008194525415202469, 0.0008223177601968911, 0.0008251829788735353, 0.0008280481975501795, 0.0008309134162268238, 0.000833778634903468, 0.0008366438535801122, 0.0008395090722567565, 0.0008423742909334006, 0.0008452395096100448, 0.0008481047282866891, 0.0008509699469633333, 0.0008538351656399775, 0.0008567003843166218, 0.000859565602993266, 0.0008624308216699101, 0.0008652960403465544, 0.0008681612590231986, 0.0008710264776998428, 0.0008738916963764871, 0.0008767569150531313, 0.0008796221337297756, 0.0008824873524064197, 0.0008853525710830639, 0.0008882177897597082, 0.0008910830084363524, 0.0008939482271129966, 0.0008968134457896409, 0.0008996786644662851, 0.0009025438831429292, 0.0009054091018195735, 0.0009082743204962177, 0.0009111395391728619, 0.0009140047578495062, 0.0009168699765261504, 0.0009197351952027946, 0.0009226004138794388, 0.000925465632556083, 0.0009283308512327272, 0.0009311960699093715, 0.0009340612885860157, 0.0009369265072626599, 0.0009397917259393042, 0.0009426569446159483, 0.0009455221632925925, 0.0009483873819692368, 0.000951252600645881, 0.0009541178193225252, 0.0009569830379991695, 0.0009598482566758136, 0.0009627134753524579, 0.0009655786940291021, 0.0009684439127057463, 0.0009713091313823906, 0.0009741743500590348, 0.000977039568735679, 0.0009799047874123233, 0.0009827700060889674, 0.0009856352247656116, 0.0009885004434422558, 0.0009913656621189, 0.0009942308807955444, 0.0009970960994721886, 0.0009999613181488327, 0.001002826536825477, 0.0010056917555021211, 0.0010085569741787653, 0.0010114221928554097, 0.0010142874115320539, 0.001017152630208698, 0.0010200178488853422, 0.0010228830675619864, 0.0010257482862386308, 0.001028613504915275, 0.0010314787235919192, 0.0010343439422685634, 0.0010372091609452076, 0.0010400743796218517, 0.0010429395982984961, 0.0010458048169751403, 0.0010486700356517845, 0.0010515352543284287, 0.0010544004730050729, 0.001057265691681717, 0.0010601309103583615, 0.0010629961290350056, 0.0010658613477116498, 0.001068726566388294, 0.0010715917850649382, 0.0010744570037415824, 0.0010773222224182268, 0.001080187441094871, 0.0010830526597715151, 0.0010859178784481593, 0.0010887830971248035, 0.0010916483158014477, 0.001094513534478092, 0.0010973787531547363, 0.0011002439718313804, 0.0011031091905080246, 0.0011059744091846688, 0.0011088396278613132, 0.0011117048465379574, 0.0011145700652146016, 0.0011174352838912458, 0.00112030050256789, 0.0011231657212445341, 0.0011260309399211785, 0.0011288961585978227, 0.0011317613772744669, 0.001134626595951111, 0.0011374918146277552, 0.0011403570333043994, 0.0011432222519810438, 0.001146087470657688, 0.0011489526893343322, 0.0011518179080109764, 0.0011546831266876206, 0.0011575483453642647, 0.0011604135640409091, 0.0011632787827175533, 0.0011661440013941975, 0.0011690092200708417, 0.0011718744387474859, 0.00117473965742413, 0.0011776048761007745, 0.0011804700947774186, 0.0011833353134540628, 0.001186200532130707, 0.0011890657508073512, 0.0011919309694839956, 0.0011947961881606398, 0.001197661406837284, 0.0012005266255139281, 0.0012033918441905723, 0.0012062570628672165, 0.001209122281543861, 0.001211987500220505, 0.0012148527188971493, 0.0012177179375737934, 0.0012205831562504376, 0.0012234483749270818, 0.0012263135936037262, 0.0012291788122803704, 0.0012320440309570146, 0.0012349092496336588, 0.001237774468310303, 0.0012406396869869471, 0.0012435049056635915, 0.0012463701243402357, 0.0012492353430168799, 0.001252100561693524, 0.0012549657803701683, 0.0012578309990468124, 0.0012606962177234568, 0.001263561436400101, 0.0012664266550767452, 0.0012692918737533894, 0.0012721570924300336, 0.0012750223111066778, 0.0012778875297833221, 0.0012807527484599663, 0.0012836179671366105, 0.0012864831858132547, 0.0012893484044898989, 0.0012922136231665433, 0.0012950788418431875, 0.0012979440605198316, 0.0013008092791964758, 0.00130367449787312, 0.0013065397165497642, 0.0013094049352264086, 0.0013122701539030528, 0.001315135372579697, 0.0013180005912563411, 0.0013208658099329853, 0.0013237310286096295, 0.001326596247286274, 0.001329461465962918, 0.0013323266846395623, 0.0013351919033162065, 0.0013380571219928506, 0.0013409223406694948, 0.0013437875593461392, 0.0013466527780227834, 0.0013495179966994276, 0.0013523832153760718, 0.001355248434052716, 0.0013581136527293601, 0.0013609788714060045, 0.0013638440900826487, 0.001366709308759293, 0.001369574527435937, 0.0013724397461125813, 0.0013753049647892254, 0.0013781701834658698, 0.001381035402142514, 0.0013839006208191582, 0.0013867658394958024, 0.0013896310581724466, 0.001392496276849091, 0.0013953614955257352, 0.0013982267142023793, 0.0014010919328790235, 0.0014039571515556677, 0.0014068223702323119, 0.0014096875889089563, 0.0014125528075856005, 0.0014154180262622447, 0.0014182832449388888, 0.001421148463615533, 0.0014240136822921772, 0.0014268789009688216, 0.0014297441196454658, 0.00143260933832211, 0.0014354745569987541, 0.0014383397756753983, 0.0014412049943520425, 0.001444070213028687, 0.001446935431705331, 0.0014498006503819753, 0.0014526658690586195, 0.0014555310877352636, 0.0014583963064119078, 0.0014612615250885522, 0.0014641267437651964, 0.0014669919624418406, 0.0014698571811184848, 0.001472722399795129, 0.0014755876184717734, 0.0014784528371484175, 0.0014813180558250617, 0.001484183274501706, 0.00148704849317835, 0.0014899137118549943, 0.0014927789305316387, 0.0014956441492082828, 0.001498509367884927, 0.0015013745865615712, 0.0015042398052382154, 0.0015071050239148596, 0.001509970242591504, 0.0015128354612681482, 0.0015157006799447923, 0.0015185658986214365, 0.0015214311172980807, 0.0015242963359747249, 0.0015271615546513693, 0.0015300267733280135, 0.0015328919920046577, 0.0015357572106813018, 0.001538622429357946, 0.0015414876480345902, 0.0015443528667112346, 0.0015472180853878788, 0.001550083304064523, 0.0015529485227411672, 0.0015558137414178113, 0.0015586789600944557, 0.0015615441787711, 0.001564409397447744, 0.0015672746161243883, 0.0015701398348010325, 0.0015730050534776766, 0.001575870272154321, 0.0015787354908309652, 0.0015816007095076094, 0.0015844659281842536, 0.0015873311468608978, 0.001590196365537542, 0.0015930615842141864, 0.0015959268028908305, 0.0015987920215674747, 0.001601657240244119, 0.001604522458920763, 0.0016073876775974073, 0.0016102528962740517, 0.0016131181149506959, 0.00161598333362734, 0.0016188485523039842, 0.0016217137709806284, 0.0016245789896572726, 0.001627444208333917, 0.0016303094270105612, 0.0016331746456872053, 0.0016360398643638495, 0.0016389050830404937, 0.001641770301717138, 0.0016446355203937823, 0.0016475007390704265, 0.0016503659577470707, 0.0016532311764237148, 0.001656096395100359, 0.0016589616137770034, 0.0016618268324536476, 0.0016646920511302918, 0.001667557269806936, 0.0016704224884835802, 0.0016732877071602243, 0.0016761529258368687, 0.001679018144513513, 0.001681883363190157, 0.0016847485818668013, 0.0016876138005434455, 0.0016904790192200897, 0.001693344237896734, 0.0016962094565733782, 0.0016990746752500224, 0.0017019398939266666, 0.0017048051126033108, 0.001707670331279955, 0.0017105355499565994, 0.0017134007686332435, 0.0017162659873098877, 0.001719131205986532, 0.001721996424663176, 0.0017248616433398203, 0.0017277268620164647, 0.0017305920806931089, 0.001733457299369753, 0.0017363225180463972, 0.0017391877367230414, 0.0017420529553996856, 0.00174491817407633, 0.0017477833927529742, 0.0017506486114296184, 0.0017535138301062625, 0.0017563790487829067, 0.0017592442674595511, 0.0017621094861361953, 0.0017649747048128395, 0.0017678399234894837, 0.0017707051421661279, 0.001773570360842772, 0.0017764355795194164, 0.0017793007981960606, 0.0017821660168727048, 0.001785031235549349, 0.0017878964542259932, 0.0017907616729026373, 0.0017936268915792817, 0.001796492110255926, 0.0017993573289325701, 0.0018022225476092143, 0.0018050877662858585, 0.0018079529849625027, 0.001810818203639147, 0.0018136834223157912, 0.0018165486409924354, 0.0018194138596690796, 0.0018222790783457238, 0.001825144297022368, 0.0018280095156990124, 0.0018308747343756566, 0.0018337399530523007, 0.001836605171728945, 0.001839470390405589, 0.0018423356090822335, 0.0018452008277588777, 0.0018480660464355219, 0.001850931265112166, 0.0018537964837888102, 0.0018566617024654544, 0.0018595269211420988, 0.001862392139818743, 0.0018652573584953872, 0.0018681225771720314, 0.0018709877958486755, 0.0018738530145253197, 0.0018767182332019641, 0.0018795834518786083, 0.0018824486705552525, 0.0018853138892318967, 0.0018881791079085409, 0.001891044326585185, 0.0018939095452618294, 0.0018967747639384736, 0.0018996399826151178, 0.001902505201291762, 0.0019053704199684062, 0.0019082356386450504, 0.0019111008573216948, 0.001913966075998339, 0.0019168312946749831, 0.0019196965133516273, 0.0019225617320282715, 0.0019254269507049159, 0.00192829216938156, 0.0019311573880582042, 0.0019340226067348484, 0.0019368878254114926, 0.0019397530440881368, 0.0019426182627647812, 0.0019454834814414254, 0.0019483487001180696, 0.0019512139187947137, 0.001954079137471358, 0.001956944356148002, 0.0019598095748246465, 0.0019626747935012905, 0.001965540012177935, 0.0019684052308545793, 0.0019712704495312232, 0.0019741356682078676, 0.0019770008868845116, 0.001979866105561156, 0.0019827313242378, 0.0019855965429144444, 0.0019884617615910888, 0.0019913269802677327, 0.001994192198944377, 0.001997057417621021, 0.0019999226362976655, 0.00200278785497431, 0.002005653073650954, 0.0020085182923275983, 0.0020113835110042422, 0.0020142487296808866, 0.0020171139483575306, 0.002019979167034175, 0.0020228443857108194, 0.0020257096043874634, 0.0020285748230641078, 0.0020314400417407517, 0.002034305260417396, 0.0020371704790940405, 0.0020400356977706845, 0.002042900916447329, 0.002045766135123973, 0.0020486313538006173, 0.0020514965724772617, 0.0020543617911539056, 0.00205722700983055, 0.002060092228507194, 0.0020629574471838384, 0.0020658226658604823, 0.0020686878845371267, 0.002071553103213771, 0.002074418321890415, 0.0020772835405670595, 0.0020801487592437035, 0.002083013977920348, 0.0020858791965969923, 0.0020887444152736362, 0.0020916096339502806, 0.0020944748526269246, 0.002097340071303569, 0.002100205289980213, 0.0021030705086568574, 0.0021059357273335018, 0.0021088009460101457, 0.00211166616468679, 0.002114531383363434, 0.0021173966020400785, 0.002120261820716723, 0.002123127039393367, 0.0021259922580700113, 0.0021288574767466552, 0.0021317226954232996, 0.002134587914099944, 0.002137453132776588, 0.0021403183514532324, 0.0021431835701298764, 0.0021460487888065208, 0.0021489140074831647, 0.002151779226159809, 0.0021546444448364535, 0.0021575096635130975, 0.002160374882189742, 0.002163240100866386, 0.0021661053195430303, 0.0021689705382196747, 0.0021718357568963186, 0.002174700975572963, 0.002177566194249607, 0.0021804314129262514, 0.0021832966316028954, 0.0021861618502795398, 0.002189027068956184, 0.002191892287632828, 0.0021947575063094725, 0.0021976227249861165, 0.002200487943662761, 0.0022033531623394053, 0.0022062183810160492, 0.0022090835996926936, 0.0022119488183693376, 0.002214814037045982, 0.0022176792557226264, 0.0022205444743992704, 0.0022234096930759148, 0.0022262749117525587, 0.002229140130429203, 0.002232005349105847, 0.0022348705677824915, 0.002237735786459136, 0.00224060100513578, 0.0022434662238124243, 0.0022463314424890682, 0.0022491966611657126, 0.002252061879842357, 0.002254927098519001, 0.0022577923171956454, 0.0022606575358722894, 0.0022635227545489338, 0.0022663879732255777, 0.002269253191902222, 0.0022721184105788665, 0.0022749836292555105, 0.002277848847932155, 0.002280714066608799, 0.0022835792852854433, 0.0022864445039620877, 0.0022893097226387316, 0.002292174941315376, 0.00229504015999202, 0.0022979053786686644, 0.002300770597345309, 0.0023036358160219528, 0.002306501034698597, 0.002309366253375241, 0.0023122314720518855, 0.0023150966907285295, 0.002317961909405174, 0.0023208271280818183, 0.0023236923467584623, 0.0023265575654351067, 0.0023294227841117506, 0.002332288002788395, 0.0023351532214650394, 0.0023380184401416834, 0.0023408836588183278, 0.0023437488774949717, 0.002346614096171616, 0.00234947931484826, 0.0023523445335249045, 0.002355209752201549, 0.002358074970878193, 0.0023609401895548373, 0.0023638054082314812, 0.0023666706269081256, 0.00236953584558477, 0.002372401064261414, 0.0023752662829380584, 0.0023781315016147024, 0.0023809967202913468, 0.002383861938967991, 0.002386727157644635, 0.0023895923763212795, 0.0023924575949979235, 0.002395322813674568, 0.002398188032351212, 0.0024010532510278563, 0.0024039184697045007, 0.0024067836883811446, 0.002409648907057789, 0.002412514125734433, 0.0024153793444110774, 0.002418244563087722, 0.0024211097817643658, 0.00242397500044101, 0.002426840219117654, 0.0024297054377942985, 0.0024325706564709425, 0.002435435875147587, 0.0024383010938242313, 0.0024411663125008753, 0.0024440315311775197, 0.0024468967498541636, 0.002449761968530808, 0.0024526271872074524, 0.0024554924058840964, 0.002458357624560741, 0.0024612228432373848, 0.002464088061914029, 0.002466953280590673, 0.0024698184992673175, 0.002472683717943962, 0.002475548936620606, 0.0024784141552972503, 0.0024812793739738942, 0.0024841445926505386, 0.002487009811327183, 0.002489875030003827, 0.0024927402486804714, 0.0024956054673571154, 0.0024984706860337598, 0.002501335904710404, 0.002504201123387048, 0.0025070663420636925, 0.0025099315607403365, 0.002512796779416981, 0.002515661998093625, 0.0025185272167702693, 0.0025213924354469137, 0.0025242576541235576, 0.002527122872800202, 0.002529988091476846, 0.0025328533101534904, 0.002535718528830135, 0.0025385837475067788, 0.002541448966183423, 0.002544314184860067, 0.0025471794035367115, 0.0025500446222133555, 0.00255290984089, 0.0025557750595666443, 0.0025586402782432883, 0.0025615054969199327, 0.0025643707155965766, 0.002567235934273221, 0.0025701011529498654, 0.0025729663716265094, 0.002575831590303154, 0.0025786968089797978, 0.002581562027656442, 0.0025844272463330866, 0.0025872924650097305, 0.002590157683686375, 0.002593022902363019, 0.0025958881210396633, 0.0025987533397163073, 0.0026016185583929517, 0.002604483777069596, 0.00260734899574624, 0.0026102142144228844, 0.0026130794330995284, 0.002615944651776173, 0.002618809870452817, 0.002621675089129461, 0.0026245403078061055, 0.0026274055264827495, 0.002630270745159394, 0.002633135963836038, 0.0026360011825126823, 0.0026388664011893267, 0.0026417316198659706, 0.002644596838542615, 0.002647462057219259, 0.0026503272758959034, 0.002653192494572548, 0.0026560577132491918, 0.002658922931925836, 0.00266178815060248, 0.0026646533692791245, 0.002667518587955769, 0.002670383806632413, 0.0026732490253090573, 0.0026761142439857013, 0.0026789794626623457, 0.0026818446813389896, 0.002684709900015634, 0.0026875751186922784, 0.0026904403373689224, 0.002693305556045567, 0.0026961707747222108, 0.002699035993398855, 0.0027019012120754996, 0.0027047664307521435, 0.002707631649428788, 0.002710496868105432, 0.0027133620867820763, 0.0027162273054587203, 0.0027190925241353647, 0.002721957742812009, 0.002724822961488653, 0.0027276881801652974, 0.0027305533988419414, 0.002733418617518586, 0.00273628383619523, 0.002739149054871874, 0.0027420142735485186, 0.0027448794922251625, 0.002747744710901807, 0.002750609929578451, 0.0027534751482550953, 0.0027563403669317397, 0.0027592055856083837, 0.002762070804285028, 0.002764936022961672, 0.0027678012416383164, 0.002770666460314961, 0.0027735316789916048, 0.002776396897668249, 0.002779262116344893, 0.0027821273350215375, 0.002784992553698182, 0.002787857772374826, 0.0027907229910514703, 0.0027935882097281143, 0.0027964534284047587, 0.0027993186470814026, 0.002802183865758047, 0.0028050490844346914, 0.0028079143031113354, 0.00281077952178798, 0.0028136447404646238, 0.002816509959141268, 0.0028193751778179126, 0.0028222403964945565, 0.002825105615171201, 0.002827970833847845, 0.0028308360525244893, 0.0028337012712011333, 0.0028365664898777777, 0.002839431708554422, 0.002842296927231066, 0.0028451621459077104, 0.0028480273645843544, 0.002850892583260999, 0.002853757801937643, 0.002856623020614287, 0.0028594882392909316, 0.0028623534579675755, 0.00286521867664422, 0.0028680838953208643, 0.0028709491139975083, 0.0028738143326741527, 0.0028766795513507967, 0.002879544770027441, 0.002882409988704085, 0.0028852752073807294, 0.002888140426057374, 0.002891005644734018, 0.002893870863410662, 0.002896736082087306, 0.0028996013007639506, 0.002902466519440595, 0.002905331738117239, 0.0029081969567938833, 0.0029110621754705273, 0.0029139273941471717, 0.0029167926128238156, 0.00291965783150046, 0.0029225230501771044, 0.0029253882688537484, 0.002928253487530393, 0.0029311187062070368];

        for (&ref_weight, &weight) in ref_weights.iter().zip(nlmf_filter.weights.iter()) {
            assert!(approx_eq!(f32, ref_weight, weight, ulps = 10), "failed weight: {} {}", ref_weight, weight);
        }

        let (output, _) = nlmf_filter.adapt(&filter_input, target, f32::MAX);
        assert!(approx_eq!(f32, output, 1023.9999985673907, ulps = 10), "Output check failed (output = {})", output);
    }
}
